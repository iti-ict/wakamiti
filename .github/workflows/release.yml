name: Release a new tagged version
on:
  release:
    types: [ released ]
  workflow_dispatch:
    inputs:
      TAG_NAME:
        description: 'Tag name'
        required: true
      TITLE:
        description: 'Release name'
        required: true
      URL:
        description: 'Release url'
        required: true
      AUTHOR:
        description: 'Release author'
        required: true

env:
  TAG_NAME: ${{ github.event.inputs.TAG_NAME || github.event.release.tag_name }}
  TITLE: ${{ github.event.inputs.TITLE || github.event.release.name }}
  URL: ${{ github.event.inputs.URL || github.event.release.url }}
  AUTHOR: ${{ github.event.inputs.AUTHOR || github.event.release.author.name }}

jobs:
  get-env:
    name: Get Environment vars
    runs-on: ubuntu-latest
    outputs:
      TAG_NAME: ${{ env.TAG_NAME }}
      TITLE: ${{ env.TITLE }}
      URL: ${{ env.URL }}
      AUTHOR: ${{ env.AUTHOR }}
    steps:
      - run: |
          echo Get variables

  build:
    name: Build
    needs: [ get-env ]
    if: ${{ startsWith(needs.get-env.outputs.TAG_NAME, 'v') || contains(needs.get-env.outputs.TAG_NAME, '-plugin-v') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:

      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_CENTRAL_TOKEN
          gpg-private-key: ${{ secrets.GPG_SECRET_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

#      - name: Build
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
#        run: ./mvnw -B install -DskipTests -ntp
#
#      - name: Publish Docker tagged version and latest version
#        run: |
#          ./mvnw -B deploy -DskipTests -ntp -pl wakamiti-engine/wakamiti-docker -P release,-default \
#          -Ddocker.pwd=${{ secrets.WAKAMITI_DOCKER_PWD }}
#
#      - name: Stage JARs into Maven Central Repository
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#          MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
#          MAVEN_CENTRAL_TOKEN: ${{ secrets.SONATYPE_PWD }}
#          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_SECRET_KEY_PASSWORD }}
#        run: |
#          ./mvnw -B -P sonatype deploy -ntp -DskipTests=true -e \
#            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
#            -DaltDeploymentRepository=ossrh::default::https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/ \
#            -Dsonar.organization=iti-ict \
#            -Dsonar.host.url=https://sonarcloud.io

      - name: Microsoft Teams Notification
        uses: skitionek/notify-microsoft-teams@master
        if: ${{ success() }}
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK }}
          raw: >-
            {
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "type": "AdaptiveCard",
                    "body": [
                      {
                        "type": "ColumnSet",
                        "columns": [
                          {
                            "type": "Column",
                            "width": "auto",
                            "items": [
                              {
                                "type": "Image",
                                "url": "data:image/png;base64,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",
                                "size": "medium"
                              }
                            ]
                          },
                          {
                            "type": "Column",
                            "items": [
                              {
                                "type": "TextBlock",
                                "size": "extraLarge",
                                "weight": "bolder",
                                "text": "Nueva versión ${{ needs.get-env.outputs.TITLE }}! 🎉",
                                "wrap": true
                              },
                              {
                                "type": "TextBlock",
                                "spacing": "none",
                                "text": "Publicada por ${{ needs.get-env.outputs.AUTHOR }}",
                                "isSubtle": true,
                                "wrap": true
                              }
                            ],
                            "width": "stretch"
                          }
                        ]
                      }
                    ],
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "Ver detalles",
                        "url": "${{ needs.get-env.outputs.URL }}"
                      }
                    ]
                  }
                }
              ]
            }
